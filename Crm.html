<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCRM Pro v2</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ... (el mismo CSS que antes) ... */
    </style>
</head>
<body>
    <div class="header">
        <span class="menu-icon" onclick="toggleSidebar()">‚ò∞</span>
        <h1>AutoCRM Pro</h1>
    </div>

    <div class="sidebar" id="sidebar">
        <ul>
            <li><a href="#" onclick="showSection('dashboard')">üìä Dashboard</a></li>
            <li><a href="#" onclick="showSection('inventory')">üöó Inventario</a></li>
            <li><a href="#" onclick="showSection('clients')">üë• Clientes</a></li>
            <li><a href="#" onclick="showSection('sales')">üí∞ Ventas</a></li>
            <li><a href="#" onclick="showSection('services')">üîß Servicios</a></li>
            <li><a href="#" onclick="showSection('pipelines')">üìà Pipelines</a></li>
            <li><a href="#" onclick="showSection('employees')">üë®‚Äçüíº Empleados</a></li>
            <li><a href="#" onclick="showSection('tags')">üè∑Ô∏è Etiquetas</a></li>
        </ul>
        <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>

    <div class="main-content" id="main-content">
        <!-- El contenido principal se cargar√° aqu√≠ din√°micamente -->
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            // Reemplaza esto con tu configuraci√≥n real de Firebase
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Funci√≥n para alternar la visibilidad del sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Funci√≥n para mostrar diferentes secciones
        function showSection(section) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `<h2>${section.charAt(0).toUpperCase() + section.slice(1)}</h2>`;
            
            switch(section) {
                case 'dashboard':
                    showDashboard();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'clients':
                    showClients();
                    break;
                case 'sales':
                    showSales();
                    break;
                case 'services':
                    showServices();
                    break;
                case 'pipelines':
                    showPipelines();
                    break;
                case 'employees':
                    showEmployees();
                    break;
                case 'tags':
                    showTags();
                    break;
            }

            toggleSidebar();
        }

        // Funci√≥n para mostrar el dashboard
        async function showDashboard() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML += `
                <div class="card">
                    <h3>Resumen de Ventas</h3>
                    <canvas id="salesChart"></canvas>
                </div>
                <div class="card">
                    <h3>Clientes Nuevos</h3>
                    <canvas id="clientsChart"></canvas>
                </div>
            `;

            try {
                const salesData = await getSalesData();
                const clientsData = await getClientsData();

                createChart('salesChart', 'Ventas Mensuales', salesData);
                createChart('clientsChart', 'Nuevos Clientes', clientsData);
            } catch (error) {
                console.error("Error al cargar datos del dashboard:", error);
                mainContent.innerHTML += `<p>Error al cargar los datos. Por favor, int√©ntelo de nuevo m√°s tarde.</p>`;
            }
        }

        // Funci√≥n para crear gr√°ficos
        function createChart(canvasId, label, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Funci√≥n para mostrar el inventario
        async function showInventory() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML += `
                <div class="card">
                    <h3>Inventario de Veh√≠culos</h3>
                    <button class="btn" onclick="showAddVehicleForm()">Agregar Veh√≠culo</button>
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>A√±o</th>
                                <th>Precio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            `;

            try {
                const inventory = await getInventoryData();
                const tableBody = document.querySelector('#inventoryTable tbody');
                tableBody.innerHTML = ''; // Limpiar la tabla antes de agregar nuevos datos
                inventory.forEach(car => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${car.brand}</td>
                        <td>${car.model}</td>
                        <td>${car.year}</td>
                        <td>$${car.price.toLocaleString()}</td>
                        <td>
                            <button onclick="editVehicle('${car.id}')">Editar</button>
                            <button onclick="deleteVehicle('${car.id}')">Eliminar</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error("Error al cargar el inventario:", error);
                mainContent.innerHTML += `<p>Error al cargar el inventario. Por favor, int√©ntelo de nuevo m√°s tarde.</p>`;
            }
        }

        // Funci√≥n para mostrar el formulario de agregar veh√≠culo
        function showAddVehicleForm() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Agregar Veh√≠culo</h3>
                    <form id="addVehicleForm">
                        <div class="form-group">
                            <label for="brand">Marca:</label>
                            <input type="text" id="brand" required>
                        </div>
                        <div class="form-group">
                            <label for="model">Modelo:</label>
                            <input type="text" id="model" required>
                        </div>
                        <div class="form-group">
                            <label for="year">A√±o:</label>
                            <input type="number" id="year" required>
                        </div>
                        <div class="form-group">
                            <label for="price">Precio:</label>
                            <input type="number" id="price" required>
                        </div>
                        <button type="submit" class="btn">Agregar Veh√≠culo</button>
                    </form>
                </div>
            `;

            document.getElementById('addVehicleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const vehicleData = {
                    brand: document.getElementById('brand').value,
                    model: document.getElementById('model').value,
                    year: parseInt(document.getElementById('year').value),
                    price: parseFloat(document.getElementById('price').value)
                };
                try {
                    await addVehicle(vehicleData);
                    alert('Veh√≠culo agregado con √©xito');
                    showInventory();
                } catch (error) {
                    console.error("Error al agregar veh√≠culo:", error);
                    alert('Error al agregar veh√≠culo. Por favor, int√©ntelo de nuevo.');
                }
            });
        }

        // Funciones para obtener datos
        async function getSalesData() {
            try {
                const salesRef = db.collection('sales');
                const snapshot = await salesRef.get();
                const salesData = snapshot.docs.map(doc => doc.data().amount);
                return salesData;
            } catch (error) {
                console.error("Error al obtener datos de ventas:", error);
                throw error;
            }
        }

        async function getClientsData() {
            try {
                const clientsRef = db.collection('clients');
                const snapshot = await clientsRef.get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener datos de clientes:", error);
                throw error;
            }
        }

        async function getInventoryData() {
            try {
                const inventoryRef = db.collection('inventory');
                const snapshot = await inventoryRef.get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener datos de inventario:", error);
                throw error;
            }
        }

        // Funciones CRUD para veh√≠culos
        async function addVehicle(vehicleData) {
            try {
                await db.collection('inventory').add(vehicleData);
            } catch (error) {
                console.error("Error al agregar veh√≠culo:", error);
                throw error;
            }
        }

        async function editVehicle(id) {
            try {
                const vehicleDoc = await db.collection('inventory').doc(id).get();
                if (vehicleDoc.exists) {
                    const vehicle = vehicleDoc.data();
                    showEditVehicleForm(id, vehicle);
                } else {
                    throw new Error("Veh√≠culo no encontrado");
                }
            } catch (error) {
                console.error("Error al editar veh√≠culo:", error);
                alert('Error al cargar los datos del veh√≠culo. Por favor, int√©ntelo de nuevo.');
            }
        }

        function showEditVehicleForm(id, vehicle) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Editar Veh√≠culo</h3>
                    <form id="editVehicleForm">
                        <input type="hidden" id="vehicleId" value="${id}">
                        <div class="form-group">
                            <label for="brand">Marca:</label>
                            <input type="text" id="brand" value="${vehicle.brand}" required>
                        </div>
                        <div class="form-group">
                            <label for="model">Modelo:</label>
                            <input type="text" id="model" value="${vehicle.model}" required>
                        </div>
                        <div class="form-group">
                            <label for="year">A√±o:</label>
                            <input type="number" id="year" value="${vehicle.year}" required>
                        </div>
                        <div class="form-group">
                            <label for="price">Precio:</label>
                            <input type="number" id="price" value="${vehicle.price}" required>
                        </div>
                        <button type="submit" class="btn">Actualizar Veh√≠culo</button>
                    </form>
                </div>
            `;

            document.getElementById('editVehicleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedVehicleData = {
                    brand: document.getElementById('brand').value,
                    model: document.getElementById('model').value,
                    year: parseInt(document.getElementById('year').value),
                    price: parseFloat(document.getElementById('price').value)
                };
                try {
                    await updateVehicle(id, updatedVehicleData);
                    alert('Veh√≠culo actualizado con √©xito');
                    showInventory();
                } catch (error) {
                    console.error("Error al actualizar veh√≠culo:", error);
                    alert('Error al actualizar el veh√≠culo. Por favor, int√©ntelo de nuevo.');
                }
            });
        }

        async function updateVehicle(id, vehicleData) {
            try {
                await db.collection('inventory').doc(id).update(vehicleData);
            } catch (error) {
                console.error("Error al actualizar veh√≠culo:", error);
                throw error;
            }
        }

        async function deleteVehicle(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este veh√≠culo?')) {
                try {
                    await db.collection('inventory').doc(id).delete();
                    alert('Veh√≠culo eliminado con √©xito');
                    showInventory();
                } catch (error) {
                    console.error("Error al eliminar veh√≠culo:", error);
                    alert('Error al eliminar el veh√≠culo. Por favor, int√©ntelo de nuevo.');
                }
            }
        }

        // Funci√≥n para cerrar sesi√≥n
        function logout() {
            firebase.auth().signOut().then(() => {
                alert('Has cerrado sesi√≥n correctamente');
                showLoginForm();
            }).catch((error) => {
                console.error('Error al cerrar sesi√≥n:', error);
                alert('Error al cerrar sesi√≥n. Por favor, int√©ntelo de nuevo.');
            });
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    showDashboard();
                } else {
                    showLoginForm();
                }
            });
        });

        function showLoginForm() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h2>Iniciar Sesi√≥n</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Contrase√±a:</label>
                            <input type="password" id="password" required>
                        </div>
                        <button type="submit" class="btn">Iniciar Sesi√≥n</button>
                    </form>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                    showDashboard();
                } catch (error) {
                    console.error("Error de autenticaci√≥n:", error);
                    alert('Error al iniciar sesi√≥n. Verifique sus credenciales.');
                }
            });
        }

        async function showClients() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Clientes</h3>
                    <button class="btn" onclick="showAddClientForm()">Agregar Cliente</button>
                    <table id="clientsTable">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Tel√©fono</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            `;

            try {
                const clients = await getClientsData();
                const tableBody = document.querySelector('#clientsTable tbody');
                tableBody.innerHTML = ''; // Limpiar la tabla antes de agregar nuevos datos
                clients.forEach(client => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${client.name}</td>
                        <td>${client.email}</td>
                        <td>${client.phone}</td>
                        <td>
                            <button onclick="editClient('${client.id}')">Editar</button>
                            <button onclick="deleteClient('${client.id}')">Eliminar</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error("Error al cargar clientes:", error);
                mainContent.innerHTML += `<p>Error al cargar los clientes. Por favor, int√©ntelo de nuevo m√°s tarde.</p>`;
            }
        }

        function showAddClientForm() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Agregar Cliente</h3>
                    <form id="addClientForm">
                        <div class="form-group">
                            <label for="name">Nombre:</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Tel√©fono:</label>
                            <input type="tel" id="phone" required>
                        </div>
                        <button type="submit" class="btn">Agregar Cliente</button>
                    </form>
                </div>
            `;

            document.getElementById('addClientForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const clientData = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value
                };
                try {
                    await addClient(clientData);
                    alert('Cliente agregado con √©xito');
                    showClients();
                } catch (error) {
                    console.error("Error al agregar cliente:", error);
                    alert('Error al agregar cliente. Por favor, int√©ntelo de nuevo.');
                }
            });
        }

        async function addClient(clientData) {
            try {
                await db.collection('clients').add(clientData);
            } catch (error) {
                console.error("Error al agregar cliente:", error);
                throw error;
            }
        }

        async function editClient(id) {
            try {
                const clientDoc = await db.collection('clients').doc(id).get();
                if (clientDoc.exists) {
                    const client = clientDoc.data();
                    showEditClientForm(id, client);
                } else {
                    throw new Error("Cliente no encontrado");
                }
            } catch (error) {
                console.error("Error al editar cliente:", error);
                alert('Error al cargar los datos del cliente. Por favor, int√©ntelo de nuevo.');
            }
        }

        function showEditClientForm(id, client) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Editar Cliente</h3>
                    <form id="editClientForm">
                        <input type="hidden" id="clientId" value="${id}">
                        <div class="form-group">
                            <label for="name">Nombre:</label>
                            <input type="text" id="name" value="${client.name}" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" value="${client.email}" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Tel√©fono:</label>
                            <input type="tel" id="phone" value="${client.phone}" required>
                        </div>
                        <button type="submit" class="btn">Actualizar Cliente</button>
                    </form>
                </div>
            `;

            document.getElementById('editClientForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedClientData = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value
                };
                try {
                    await updateClient(id, updatedClientData);
                    alert('Cliente actualizado con √©xito');
                    showClients();
                } catch (error) {
                    console.error("Error al actualizar cliente:", error);
                    alert('Error al actualizar el cliente. Por favor, int√©ntelo de nuevo.');
                }
            });
        }

        async function updateClient(id, clientData) {
            try {
                await db.collection('clients').doc(id).update(clientData);
            } catch (error) {
                console.error("Error al actualizar cliente:", error);
                throw error;
            }
        }

        async function deleteClient(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este cliente?')) {
                try {
                    await db.collection('clients').doc(id).delete();
                    alert('Cliente eliminado con √©xito');
                    showClients();
                } catch (error) {
                    console.error("Error al eliminar cliente:", error);
                    alert('Error al eliminar el cliente. Por favor, int√©ntelo de nuevo.');
                }
            }
        }

        async function showSales() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Ventas</h3>
                    <button class="btn" onclick="showAddSaleForm()">Registrar Venta</button>
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Veh√≠culo</th>
                                <th>Monto</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            `;

            try {
                const sales = await getSalesData();
                const tableBody = document.querySelector('#salesTable tbody');
                tableBody.innerHTML = ''; // Limpiar la tabla antes de agregar nuevos datos
                for (const sale of sales) {
                    const clientDoc = await db.collection('clients').doc(sale.clientId).get();
                    const vehicleDoc = await db.collection('inventory').doc(sale.vehicleId).get();
                    const clientName = clientDoc.exists ? clientDoc.data().name : 'Cliente desconocido';
                    const vehicleName = vehicleDoc.exists ? `${vehicleDoc.data().brand} ${vehicleDoc.data().model}` : 'Veh√≠culo desconocido';
                    
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(sale.date).toLocaleDateString()}</td>
                        <td>${clientName}</td>
                        <td>${vehicleName}</td>
                        <td>$${sale.amount.toLocaleString()}</td>
                        <td>
                            <button onclick="editSale('${sale.id}')">Editar</button>
                            <button onclick="deleteSale('${sale.id}')">Eliminar</button>
                        </td>
                    `;
                }
            } catch (error) {
                console.error("Error al cargar ventas:", error);
                mainContent.innerHTML += `<p>Error al cargar las ventas. Por favor, int√©ntelo de nuevo m√°s tarde.</p>`;
            }
        }

        function showAddSaleForm() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Registrar Nueva Venta</h3>
                    <form id="addSaleForm">
                        <div class="form-group">
                            <label for="clientId">Cliente:</label>
                            <select id="clientId" required>
                                <option value="">Seleccione un cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vehicleId">Veh√≠culo:</label>
                            <select id="vehicleId" required>
                                <option value="">Seleccione un veh√≠culo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">Monto:</label>
                            <input type="number" id="amount" required min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="date">Fecha:</label>
                            <input type="date" id="date" required>
                        </div>
                        <button type="submit" class="btn">Registrar Venta</button>
                    </form>
                </div>
            `;

            loadClientsIntoSelect();
            loadVehiclesIntoSelect();

            document.getElementById('addSaleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const saleData = {
                    clientId: document.getElementById('clientId').value,
                    vehicleId: document.getElementById('vehicleId').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    date: document.getElementById('date').value
                };
                try {
                    await addSale(saleData);
                    alert('Venta registrada con √©xito');
                    showSales();
                } catch (error) {
                    console.error("Error al registrar venta:", error);
                    alert('Error al registrar la venta. Por favor, int√©ntelo de nuevo.');
                }
            });
        }

        async function loadClientsIntoSelect() {
            try {
                const clients = await getClientsData();
                const select = document.getElementById('clientId');
                select.innerHTML = '<option value="">Seleccione un cliente</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar clientes:", error);
                alert('Error al cargar la lista de clientes. Por favor, recargue la p√°gina.');
            }
        }

        async function loadVehiclesIntoSelect() {
            try {
                const vehicles = await getInventoryData();
                const select = document.getElementById('vehicleId');
                select.innerHTML = '<option value="">Seleccione un veh√≠culo</option>';
                vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.brand} ${vehicle.model} (${vehicle.year})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar veh√≠culos:", error);
                alert('Error al cargar la lista de veh√≠culos. Por favor, recargue la p√°gina.');
            }
        }

        async function addSale(saleData) {
            try {
                await db.collection('sales').add(saleData);
            } catch (error) {
                console.error("Error al agregar venta:", error);
                throw error;
            }
        }

        async function editSale(id) {
            try {
                const saleDoc = await db.collection('sales').doc(id).get();
                if (saleDoc.exists) {
                    const sale = saleDoc.data();
                    showEditSaleForm(id, sale);
                } else {
                    throw new Error("Venta no encontrada");
                }
            } catch (error) {
                console.error("Error al editar venta:", error);
                alert('Error al cargar los datos de la venta. Por favor, int√©ntelo de nuevo.');
            }
        }

        function showEditSaleForm(id, sale) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Editar Venta</h3>
                    <form id="editSaleForm">
                        <input type="hidden" id="saleId" value="${id}">
                        <div class="form-group">
                            <label for="clientId">Cliente:</label>
                            <select id="clientId" required>
                                <option value="">Seleccione un cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vehicleId">Veh√≠culo:</label>
                            <select id="vehicleId" required>
                                <option value="">Seleccione un veh√≠culo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">Monto:</label>
                            <input type="number" id="amount" value="${sale.amount}" required min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="date">Fecha:</label>
                            <input type="date" id="date" value="${sale.date}" required>
                        </div>
                        <button type="submit" class="btn">Actualizar Venta</button>
                    </form>
                </div>
            `;

            loadClientsIntoSelect(sale.clientId);
            loadVehiclesIntoSelect(sale.vehicleId);

            document.getElementById('editSaleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedSaleData = {
                    clientId: document.getElementById('clientId').value,
                    vehicleId: document.getElementById('vehicleId').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    date: document.getElementById('date').value
                };
                try {
                    await updateSale(id, updatedSaleData);
                    alert('Venta actualizada con √©xito');
                    showSales();
                } catch (error) {
                    console.error("Error al actualizar venta:", error);
                    alert('Error al actualizar la venta. Por favor, int√©ntelo de nuevo.');
                }
            });
        }

        async function updateSale(id, saleData) {
            try {
                await db.collection('sales').doc(id).update(saleData);
            } catch (error) {
                console.error("Error al actualizar venta:", error);
                throw error;
            }
        }

        async function deleteSale(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta venta?')) {
                try {
                    await db.collection('sales').doc(id).delete();
                    alert('Venta eliminada con √©xito');
                    showSales();
                } catch (error) {
                    console.error("Error al eliminar venta:", error);
                    alert('Error al eliminar la venta. Por favor, int√©ntelo de nuevo.');
                }
            }
        }

        async function showServices() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Servicios</h3>
                    <button class="btn" onclick="showAddServiceForm()">Programar Servicio</button>
                    <table id="servicesTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Veh√≠culo</th>
                                <th>Tipo de Servicio</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            `;

            try {
                const services = await getServicesData();
                const tableBody = document.querySelector('#servicesTable tbody');
                tableBody.innerHTML = ''; // Limpiar la tabla antes de agregar nuevos datos
                for (const service of services) {
                    const clientDoc = await db.collection('clients').doc(service.clientId).get();
                    const vehicleDoc = await db.collection('inventory').doc(service.vehicleId).get();
                    const clientName = clientDoc.exists ? clientDoc.data().name : 'Cliente desconocido';
                    const vehicleName = vehicleDoc.exists ? `${vehicleDoc.data().brand} ${vehicleDoc.data().model}` : 'Veh√≠culo desconocido';
                    
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(service.date).toLocaleDateString()}</td>
                        <td>${clientName}</td>
                        <td>${vehicleName}</td>
                        <td>${service.serviceType}</td>
                        <td>${service.status}</td>
                        <td>
                            <button onclick="editService('${service.id}')">Editar</button>
                            <button onclick="deleteService('${service.id}')">Eliminar</button>
                        </td>
                    `;
                }
            } catch (error) {
                console.error("Error al cargar servicios:", error);
                mainContent.innerHTML += `<p>Error al cargar los servicios. Por favor, int√©ntelo de nuevo m√°s tarde.</p>`;
            }
        }

        function showAddServiceForm() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Programar Nuevo Servicio</h3>
                    <form id="addServiceForm">
                        <div class="form-group">
                            <label for="clientId">Cliente:</label>
                            <select id="clientId" required>
                                <option value="">Seleccione un cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vehicleId">Veh√≠culo:</label>
                            <select id="vehicleId" required>
                                <option value="">Seleccione un veh√≠culo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serviceType">Tipo de Servicio:</label>
                            <input type="text" id="serviceType" required>
                        </div>
                        <div class="form-group">
                            <label for="date">Fecha:</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="status">Estado:</label>
                            <select id="status" required>
                                <option value="Programado">Programado</option>
                                <option value="En Progreso">En Progreso</option>
                                <option value="Completado">Completado</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Programar Servicio</button>
                    </form>
                </div>
            `;

            loadClientsIntoSelect();
            loadVehiclesIntoSelect();

            document.getElementById('addServiceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const serviceData = {
                    clientId: document.getElementById('clientId').value,
                    vehicleId: document.getElementById('vehicleId').value,
                    serviceType: document.getElementById('serviceType').value,
                    date: document.getElementById('date').value,
                    status: document.getElementById('status').value
                };
                try {
                    await addService(serviceData);
                    alert('Servicio programado con √©xito');
                    showServices();
                } catch (error) {
                    console.error("Error al programar servicio:", error);
                    alert('Error al programar el servicio. Por favor, int√©ntelo de nuevo.');
                }
            });
        }

        async function addService(serviceData) {
            try {
                await db.collection('services').add(serviceData);
            } catch (error) {
                console.error("Error al agregar servicio:", error);
                throw error;
            }
        }

        async function editService(id) {
            try {
                const serviceDoc = await db.collection('services').doc(id).get();
                if (serviceDoc.exists) {
                    const service = serviceDoc.data();
                    showEditServiceForm(id, service);
                } else {
                    throw new Error("Servicio no encontrado");
                }
            } catch (error) {
                console.error("Error al editar servicio:", error);
                alert('Error al cargar los datos del servicio. Por favor, int√©ntelo de nuevo.');
            }
        }

        function showEditServiceForm(id, service) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <h3>Editar Servicio</h3>
                    <form id="editServiceForm">
                        <input type="hidden" id="serviceId" value="${id}">
                        <div class="form-group">
                            <label for="clientId">Cliente:</label>
                            <select id="clientId" required>
                                <option value="">Seleccione un cliente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vehicleId">Veh√≠culo:</label>
                            <select id="vehicleId" required>
                                <option value="">Seleccione un veh√≠culo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="serviceType">Tipo de Servicio:</label>
                            <input type="text" id="serviceType" value="${service.serviceType}" required>
                        </div>
                        <div class="form-group">
                            <label for="date">Fecha:</label>
                            <input type="date" id="date" value="${service.date}" required>
                        </div>
                        <div class="form-group">
                            <label for="status">Estado:</label>
                            <select id="status" required>
                                <option value="Programado" ${service.status === 'Programado' ? 'selected' : ''}>Programado</option>
                                <option value="En Progreso" ${service.status === 'En Progreso' ? 'selected' : ''}>En Progreso</option>
                                <option value="Completado" ${service.status === 'Completado' ? 'selected' : ''}>Completado</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Actualizar Servicio</button>
                    </form>
                </div>
            `;

            loadClientsIntoSelect(service.clientId);
            loadVehiclesIntoSelect(service.vehicleId);

            document.getElementById('editServiceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedServiceData = {
                    clientId: document.getElementById('clientId').value,
                    vehicleId: document.getElementById('vehicleId').value,
                    serviceType: document.getElementById('serviceType').value,
                    date: document.getElementById('date').value,
                    status: document.getElementById('status').value
                };
                try {
                    await updateService(id, updatedServiceData);
                    alert('Servicio actualizado con √©xito');
                    showServices();
                } catch (error) {
                    console.error("Error al actualizar servicio:", error);
                    alert('Error al actualizar el servicio. Por favor, int√©ntelo de nuevo.');
                }
            });
        }

        async function updateService(id, serviceData) {
            try {
                await db.collection('services').doc(id).update(serviceData);
            } catch (error) {
                console.error("Error al actualizar servicio:", error);
                throw error;
            }
        }

        async function deleteService(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este servicio?')) {
                try {
                    await db.collection('services').doc(id).delete();
                    alert('Servicio eliminado con √©xito');
                    showServices();
                } catch (error) {
                    console.error("Error al eliminar servicio:", error);
                    alert('Error al eliminar el servicio. Por favor, int√©ntelo de nuevo.');
                }
            }
        }

        async function getServicesData() {
            try {
                const servicesRef = db.collection('services');
                const snapshot = await servicesRef.get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener datos de servicios:", error);
                throw error;
            }
        }

        // Manejo de errores global
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Error no capturado:", error);
            alert("Ha ocurrido un error inesperado. Por favor, recargue la p√°gina e int√©ntelo de nuevo.");
            return true;
        };

        // Inicializaci√≥n de Firebase
        function initializeFirebase() {
            if (!firebase.apps.length) {
                try {
                    firebase.initializeApp(firebaseConfig);
                } catch (error) {
                    console.error("Error al inicializar Firebase:", error);
                    alert("Error al inicializar la aplicaci√≥n. Por favor, recargue la p√°gina.");
                }
            }
            return firebase.firestore();
        }

        // Iniciar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            db = initializeFirebase();
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    showDashboard();
                } else {
                    showLoginForm();
                }
            });
        });

    </script>
</body>
</html>
