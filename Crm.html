<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCRM Pro v2</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #ecf0f1;
            --text-color: #34495e;
            --sidebar-width: 250px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        #main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1, h2, h3 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #27ae60;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .pipeline {
            display: flex;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .pipeline-stage {
            min-width: 250px;
            background-color: #f1f1f1;
            margin-right: 20px;
            padding: 15px;
            border-radius: 8px;
        }

        .pipeline-card {
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 50%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .tag {
            display: inline-block;
            background-color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 20px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                height: auto;
            }

            #main-content {
                width: 100%;
            }

            .modal-content {
                width: 90%;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .pipeline {
                flex-direction: column;
            }

            .pipeline-stage {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>AutoCRM Pro v2</h2>
        <nav>
            <ul>
                <li><a href="#" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" onclick="showSection('inventory')"><i class="fas fa-car"></i> Inventario</a></li>
                <li><a href="#" onclick="showSection('clients')"><i class="fas fa-users"></i> Clientes</a></li>
                <li><a href="#" onclick="showSection('sales')"><i class="fas fa-dollar-sign"></i> Ventas</a></li>
                <li><a href="#" onclick="showSection('services')"><i class="fas fa-tools"></i> Servicios</a></li>
                <li><a href="#" onclick="showSection('pipelines')"><i class="fas fa-project-diagram"></i> Pipelines</a></li>
                <li><a href="#" onclick="showSection('employees')"><i class="fas fa-user-tie"></i> Empleados</a></li>
                <li><a href="#" onclick="showSection('tags')"><i class="fas fa-tags"></i> Etiquetas</a></li>
            </ul>
        </nav>
        <button onclick="logout()" style="margin-top: 20px; width: 100%;">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </button>
    </div>
    <div id="main-content"></div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Collections
        const inventoryCollection = db.collection('inventory');
        const clientsCollection = db.collection('clients');
        const salesCollection = db.collection('sales');
        const servicesCollection = db.collection('services');
        const pipelinesCollection = db.collection('pipelines');
        const employeesCollection = db.collection('employees');
        const tagsCollection = db.collection('tags');

        // Global Variables
        let currentUser;

        // Utility functions
        function showSection(section) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '';

            switch(section) {
                case 'dashboard':
                    showDashboard();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'clients':
                    showClients();
                    break;
                case 'sales':
                    showSales();
                    break;
                case 'services':
                    showServices();
                    break;
                case 'pipelines':
                    showPipelines();
                    break;
                case 'employees':
                    showEmployees();
                    break;
                case 'tags':
                    showTags();
                    break;
            }
        }

        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = content;
            modal.style.display = 'block';

            const span = document.getElementsByClassName('close')[0];
            span.onclick = function() {
                modal.style.display = 'none';
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // Dashboard
        async function showDashboard() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h1>Dashboard</h1>
                <div class="dashboard">
                    <div class="card">
                        <h2>Resumen de Ventas</h2>
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Inventario</h2>
                        <canvas id="inventoryChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Clientes Nuevos</h2>
                        <canvas id="clientsChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Resumen de Pipeline</h2>
                        <canvas id="pipelineChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Rendimiento de Vendedores</h2>
                        <canvas id="employeePerformanceChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Servicios Programados</h2>
                        <ul id="scheduledServices"></ul>
                    </div>
                </div>
            `;

            const sales = await getSales();
            const inventory = await getInventory();
            const clients = await getClients();
            const pipelines = await getPipelines();
            const employees = await getEmployees();
            const services = await getServices();

            createSalesChart(sales);
            createInventoryChart(inventory);
            createClientsChart(clients);
            createPipelineChart(pipelines);
            createEmployeePerformanceChart(employees, sales);
            displayScheduledServices(services);
        }

        function createSalesChart(sales) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const monthlySales = sales.reduce((acc, sale) => {
                const month = new Date(sale.date.toDate()).getMonth();
                acc[month] = (acc[month] || 0) + sale.amount;
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [{
                        label: 'Ventas Mensuales',
                        data: Array.from({length: 12}, (_, i) => monthlySales[i] || 0),
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createInventoryChart(inventory) {
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            const statusCounts = inventory.reduce((acc, vehicle) => {
                acc[vehicle.status] = (acc[vehicle.status] || 0) + 1;
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['rgba(46, 204, 113, 0.6)', 'rgba(231, 76, 60, 0.6)', 'rgba(241, 196, 15, 0.6)'],
                        borderColor: ['rgba(46, 204, 113, 1)', 'rgba(231, 76, 60, 1)', 'rgba(241, 196, 15, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Estado del Inventario'
                        }
                    }
                }
            });
        }
         function createClientsChart(clients) {
            const ctx = document.getElementById('clientsChart').getContext('2d');
            const clientsPerMonth = clients.reduce((acc, client) => {
                const month = new Date(client.createdAt.toDate()).getMonth();
                acc[month] = (acc[month] || 0) + 1;
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [{
                        label: 'Nuevos Clientes',
                        data: Array.from({length: 12}, (_, i) => clientsPerMonth[i] || 0),
                        borderColor: 'rgb(52, 152, 219)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createPipelineChart(pipelines) {
            const ctx = document.getElementById('pipelineChart').getContext('2d');
            const pipelineData = pipelines.reduce((acc, pipeline) => {
                pipeline.stages.forEach(stage => {
                    acc[stage.name] = (acc[stage.name] || 0) + stage.opportunities.length;
                });
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(pipelineData),
                    datasets: [{
                        label: 'Oportunidades por Etapa',
                        data: Object.values(pipelineData),
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createEmployeePerformanceChart(employees, sales) {
            const ctx = document.getElementById('employeePerformanceChart').getContext('2d');
            const employeePerformance = employees.map(employee => {
                const employeeSales = sales.filter(sale => sale.employeeId === employee.id);
                const totalSales = employeeSales.reduce((sum, sale) => sum + sale.amount, 0);
                return {
                    name: employee.name,
                    totalSales: totalSales
                };
            }).sort((a, b) => b.totalSales - a.totalSales).slice(0, 5);  // Top 5 empleados

            new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: employeePerformance.map(emp => emp.name),
                    datasets: [{
                        label: 'Ventas Totales',
                        data: employeePerformance.map(emp => emp.totalSales),
                        backgroundColor: 'rgba(46, 204, 113, 0.6)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayScheduledServices(services) {
            const servicesList = document.getElementById('scheduledServices');
            services.filter(service => service.status === 'Programado')
                    .sort((a, b) => a.date.toDate() - b.date.toDate())
                    .slice(0, 5)  // Mostrar solo los próximos 5 servicios
                    .forEach(service => {
                        const li = document.createElement('li');
                        li.textContent = `${service.date.toDate().toLocaleDateString()}: ${service.description}`;
                        servicesList.appendChild(li);
                    });
        }

        // Pipelines
        async function showPipelines() {
            const mainContent = document.getElementById('main-content');
            const pipelines = await getPipelines();

            let pipelinesHTML = `
                <h1>Pipelines</h1>
                <button onclick="showAddPipelineForm()">Crear Nueva Pipeline</button>
                <div id="pipelines-container">
            `;

            pipelines.forEach(pipeline => {
                pipelinesHTML += `
                    <div class="card">
                        <h2>${pipeline.name}</h2>
                        <button onclick="showPipeline('${pipeline.id}')">Ver Pipeline</button>
                        <button onclick="editPipeline('${pipeline.id}')">Editar</button>
                        <button onclick="deletePipeline('${pipeline.id}')">Eliminar</button>
                    </div>
                `;
            });

            pipelinesHTML += '</div>';
            mainContent.innerHTML = pipelinesHTML;
        }

        async function showPipeline(pipelineId) {
            const pipeline = await getPipeline(pipelineId);
            const mainContent = document.getElementById('main-content');

            let pipelineHTML = `
                <h1>${pipeline.name}</h1>
                <button onclick="showAddOpportunityForm('${pipelineId}')">Agregar Oportunidad</button>
                <div class="pipeline">
            `;

            pipeline.stages.forEach(stage => {
                pipelineHTML += `
                    <div class="pipeline-stage" id="${stage.id}">
                        <h3>${stage.name}</h3>
                `;

                stage.opportunities.forEach(opportunity => {
                    pipelineHTML += `
                        <div class="pipeline-card" draggable="true" ondragstart="drag(event)" id="${opportunity.id}">
                            <h4>${opportunity.clientName}</h4>
                            <p>${opportunity.description}</p>
                            <p>Valor: $${opportunity.value.toLocaleString()}</p>
                            <button onclick="editOpportunity('${pipelineId}', '${opportunity.id}')">Editar</button>
                            <button onclick="deleteOpportunity('${pipelineId}', '${opportunity.id}')">Eliminar</button>
                        </div>
                    `;
                });

                pipelineHTML += `</div>`;
            });

            pipelineHTML += `</div>`;
            mainContent.innerHTML = pipelineHTML;

            // Añadir funcionalidad de arrastrar y soltar
            const stages = document.querySelectorAll('.pipeline-stage');
            stages.forEach(stage => {
                stage.addEventListener('dragover', allowDrop);
                stage.addEventListener('drop', drop);
            });
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        async function drop(ev) {
            ev.preventDefault();
            const opportunityId = ev.dataTransfer.getData("text");
            const newStageId = ev.target.closest('.pipeline-stage').id;
            const pipelineId = document.querySelector('.pipeline').id;

            await updateOpportunityStage(pipelineId, opportunityId, newStageId);
            showPipeline(pipelineId);
        }

        function showAddPipelineForm() {
            const formHTML = `
                <h2>Crear Nueva Pipeline</h2>
                <form id="addPipelineForm">
                    <div class="form-group">
                        <label for="name">Nombre de la Pipeline:</label>
                        <input type="text" id="name" required>
                    </div>
                    <div id="stages">
                        <div class="form-group">
                            <label for="stage1">Etapa 1:</label>
                            <input type="text" id="stage1" required>
                        </div>
                    </div>
                    <button type="button" onclick="addStageField()">Añadir Etapa</button>
                    <button type="submit">Crear Pipeline</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('addPipelineForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('name').value;
                const stages = Array.from(document.querySelectorAll('#stages input')).map(input => ({
                    name: input.value,
                    opportunities: []
                }));
                await addPipeline({ name, stages });
                document.getElementById('modal').style.display = 'none';
                showPipelines();
            });
        }

        function addStageField() {
            const stagesContainer = document.getElementById('stages');
            const stageCount = stagesContainer.children.length + 1;
            const newStage = document.createElement('div');
            newStage.className = 'form-group';
            newStage.innerHTML = `
                <label for="stage${stageCount}">Etapa ${stageCount}:</label>
                <input type="text" id="stage${stageCount}" required>
            `;
            stagesContainer.appendChild(newStage);
        }

        function showAddOpportunityForm(pipelineId) {
            const formHTML = `
                <h2>Agregar Oportunidad</h2>
                <form id="addOpportunityForm">
                    <div class="form-group">
                        <label for="clientName">Nombre del Cliente:</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Descripción:</label>
                        <textarea id="description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="value">Valor:</label>
                        <input type="number" id="value" required>
                    </div>
                    <div class="form-group">
                        <label for="employeeId">Empleado Asignado:</label>
                        <select id="employeeId" required>
                            ${await getEmployeeOptionsHTML()}
                        </select>
                    </div>
                    <button type="submit">Agregar Oportunidad</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('addOpportunityForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const opportunity = {
                    clientName: document.getElementById('clientName').value,
                    description: document.getElementById('description').value,
                    value: parseFloat(document.getElementById('value').value),
                    employeeId: document.getElementById('employeeId').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await addOpportunity(pipelineId, opportunity);
                document.getElementById('modal').style.display = 'none';
                showPipeline(pipelineId);
            });
        }

        async function getEmployeeOptionsHTML() {
            const employees = await getEmployees();
            return employees.map(employee => `<option value="${employee.id}">${employee.name}</option>`).join('');
        }

        // Employees
        async function showEmployees() {
            const mainContent = document.getElementById('main-content');
            const employees = await getEmployees();

            let employeesHTML = `
                <h1>Empleados</h1>
                <button onclick="showAddEmployeeForm()">Agregar Empleado</button>
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            employees.forEach(employee => {
                employeesHTML += `
                    <tr>
                        <td>${employee.name}</td>
                        <td>${employee.email}</td>
                        <td>${employee.role}</td>
                        <td>
                            <button onclick="editEmployee('${employee.id}')">Editar</button>
                            <button onclick="deleteEmployee('${employee.id}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            });

            employeesHTML += `
                    </tbody>
                </table>
            `;

            mainContent.innerHTML = employeesHTML;
        }

        function showAddEmployeeForm() {
            const formHTML = `
                <h2>Agregar Empleado</h2>
                <form id="addEmployeeForm">
                    <div class="form-group">
                        <label for="name">Nombre:</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="role">Rol:</label>
                        <select id="role" required>
                            <option value="vendedor">Vendedor</option>
                            <option value="gerente">Gerente</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <button type="submit">Agregar Empleado</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const employee = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    role: document.getElementById('role').value
                };
                await addEmployee(employee);
                document.getElementById('modal').style.display = 'none';
                showEmployees();
            });
        }

        // Tags
        async function showTags() {
            const mainContent = document.getElementById('main-content');
            const tags = await getTags();

            let tagsHTML = `
                <h1>Etiquetas</h1>
                <button onclick="showAddTagForm()">Agregar Etiqueta</button>
                <div id="tags-container">
            `;

            tags.forEach(tag => {
                tagsHTML += `
                    <div class="tag">
                        ${tag.name}
                        <button onclick="editTag('${tag.id}')">Editar</button>
                        <button onclick="deleteTag('${tag.id}')">Eliminar</button>
                    </div>
                `;
            });

            tagsHTML += `
                </div>
            `;

            mainContent.innerHTML = tagsHTML;
        }

        function showAddTagForm() {
            const formHTML = `
                <h2>Agregar Etiqueta</h2>
                <form id="addTagForm">
                    <div class="form-group">
                        <label for="name">Nombre de la Etiqueta:</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="color">Color:</label>
                        <input type="color" id="color" required>
                    </div>
                    <button type="submit">Agregar Etiqueta</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('addTagForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const tag = {
                    name: document.getElementById('name').value,
                    color: document.getElementById('color').value
                };
                await addTag(tag);
                document.getElementById('modal').style.display = 'none';
                showTags();
            });
        }

        // Reportes Avanzados
        async function showAdvancedReports() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h1>Reportes Avanzados</h1>
                <div class="dashboard">
                    <div class="card">
                        <h2>Rendimiento de Ventas por Empleado</h2>
                        <canvas id="employeeSalesChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Conversión de Pipeline</h2>
                        <canvas id="pipelineConversionChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Análisis de Clientes</h2>
                        <canvas id="customerAnalysisChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Pronóstico de Ventas</h2>
                        <canvas id="salesForecastChart"></canvas>
                    </div>
                </div>
            `;

            const sales = await getSales();
            const employees = await getEmployees();
            const pipelines = await getPipelines();
            const clients = await getClients();

            createEmployeeSalesChart(sales, employees);
            createPipelineConversionChart(pipelines);
            createCustomerAnalysisChart(clients, sales);
            createSalesForecastChart(sales);
        }

        function createEmployeeSalesChart(sales, employees) {
            const ctx = document.getElementById('employeeSalesChart').getContext('2d');
            const employeeSales = employees.map(employee => {
                const totalSales = sales
                    .filter(sale => sale.employeeId === employee.id)
                    .reduce((sum, sale) => sum + sale.amount, 0);
                return { name: employee.name, sales: totalSales };
            }).sort((a, b) => b.sales - a.sales);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: employeeSales.map(emp => emp.name),
                    datasets: [{
                        label: 'Ventas Totales',
                        data: employeeSales.map(emp => emp.sales),
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createPipelineConversionChart(pipelines) {
            const ctx = document.getElementById('pipelineConversionChart').getContext('2d');
            const stageConversions = pipelines.flatMap(pipeline => {
                const stageData = pipeline.stages.map((stage, index, stages) => {
                    const currentCount = stage.opportunities.length;
                    const nextCount = index < stages.length - 1 ? stages[index + 1].opportunities.length : 0;
                    const conversionRate = nextCount > 0 ? (nextCount / currentCount) * 100 : 0;
                    return { name: stage.name, conversionRate };
                });
                return stageData.slice(0, -1); // Excluir la última etapa
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: stageConversions.map(stage => stage.name),
                    datasets: [{
                        label: 'Tasa de Conversión (%)',
                        data: stageConversions.map(stage => stage.conversionRate),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCustomerAnalysisChart(clients, sales) {
            const ctx = document.getElementById('customerAnalysisChart').getContext('2d');
            const customerData = clients.map(client => {
                const clientSales = sales.filter(sale => sale.clientId === client.id);
                const totalPurchases = clientSales.reduce((sum, sale) => sum + sale.amount, 0);
                const frequency = clientSales.length;
                return { name: client.name, totalPurchases, frequency };
            }).sort((a, b) => b.totalPurchases - a.totalPurchases).slice(0, 10); // Top 10 clientes

            new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Análisis de Clientes',
                        data: customerData.map(customer => ({
                            x: customer.totalPurchases,
                            y: customer.frequency,
                            r: Math.sqrt(customer.totalPurchases) / 100, // Tamaño de la burbuja basado en compras totales
                            name: customer.name
                        })),
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Compras Totales ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frecuencia de Compra'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const data = context.dataset.data[context.dataIndex];
                                    return `${data.name}: $${data.x.toLocaleString()} (${data.y} compras)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createSalesForecastChart(sales) {
            const ctx = document.getElementById('salesForecastChart').getContext('2d');
            const monthlySales = sales.reduce((acc, sale) => {
                const month = new Date(sale.date.toDate()).getMonth();
                acc[month] = (acc[month] || 0) + sale.amount;
                return acc;
            }, {});

            const monthlyData = Array.from({ length: 12 }, (_, i) => monthlySales[i] || 0);
            const forecast = calculateForecast(monthlyData);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [
                        {
                            label: 'Ventas Reales',
                            data: monthlyData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Pronóstico',
                            data: forecast,
                            borderColor: 'rgb(255, 99, 132)',
                            borderDash: [5, 5],
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculateForecast(data) {
            // Implementar un algoritmo de pronóstico simple (por ejemplo, promedio móvil)
            const windowSize = 3;
            return data.map((_, index, array) => {
                if (index < windowSize - 1) return null;
                const window = array.slice(index - windowSize + 1, index + 1);
                return window.reduce((sum, value) => sum + value, 0) / windowSize;
            });
        }

        // Automatización
        async function setupAutomations() {
            // Configurar listeners para eventos que desencadenan automatizaciones
            db.collection('clients').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const newClient = { id: change.doc.id, ...change.doc.data() };
                        handleNewClientAutomation(newClient);
                    }
                });
            });

            db.collection('sales').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const newSale = { id: change.doc.id, ...change.doc.data() };
                        handleNewSaleAutomation(newSale);
                    }
                });
            });

            // Más listeners para otros eventos relevantes...
        }

        async function handleNewClientAutomation(client) {
            // Ejemplo: Asignar automáticamente un vendedor al nuevo cliente
            const employees = await getEmployees();
            const salesEmployees = employees.filter(emp => emp.role === 'vendedor');
            const assignedEmployee = salesEmployees[Math.floor(Math.random() * salesEmployees.length)];

            await updateClient(client.id, { assignedEmployeeId: assignedEmployee.id });

            // Enviar notificación al empleado asignado (simulado)
            console.log(`Notificación: Nuevo cliente ${client.name} asignado a ${assignedEmployee.name}`);
        }

        async function handleNewSaleAutomation(sale) {
            // Ejemplo: Actualizar automáticamente el estado de la oportunidad relacionada
            const pipelines = await getPipelines();
            for (const pipeline of pipelines) {
                for (const stage of pipeline.stages) {
                    const opportunity = stage.opportunities.find(opp => opp.clientId === sale.clientId);
                    if (opportunity) {
                        await updateOpportunityStage(pipeline.id, opportunity.id, 'closed');
                        console.log(`Oportunidad ${opportunity.id} cerrada automáticamente debido a la venta ${sale.id}`);
                        return;
                    }
                }
            }

            // Enviar notificación de venta al gerente (simulado)
            console.log(`Notificación: Nueva venta registrada por un valor de $${sale.amount}`);
        }

        // Funciones de utilidad adicionales
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    currentUser = user;
                    showDashboard();
                    setupAutomations();
                } else {
                    showLoginForm();
                }
            });
        });

        // Manejo global de errores
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Error no capturado:", error);
            showErrorMessage("Ha ocurrido un error inesperado. Por favor, recargue la página e intente de nuevo.");
            return true;
        };

    </script>
</body>
</html>
      
