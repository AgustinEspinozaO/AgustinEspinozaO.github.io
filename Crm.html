<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCRM Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #ecf0f1;
            --text-color: #34495e;
            --sidebar-width: 250px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            transition: all 0.3s ease;
        }

        #sidebar h2 {
            margin-bottom: 30px;
            font-size: 24px;
            text-align: center;
        }

        #sidebar ul {
            list-style-type: none;
        }

        #sidebar ul li {
            margin-bottom: 15px;
        }

        #sidebar ul li a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        #sidebar ul li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #sidebar ul li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        #main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1, h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #27ae60;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .pipeline {
            display: flex;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .pipeline-stage {
            min-width: 250px;
            background-color: #f1f1f1;
            margin-right: 20px;
            padding: 15px;
            border-radius: 8px;
        }

        .pipeline-card {
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 50%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                margin-bottom: 20px;
            }

            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>AutoCRM Pro</h2>
        <nav>
            <ul>
                <li><a href="#" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" onclick="showSection('inventory')"><i class="fas fa-car"></i> Inventario</a></li>
                <li><a href="#" onclick="showSection('clients')"><i class="fas fa-users"></i> Clientes</a></li>
                <li><a href="#" onclick="showSection('sales')"><i class="fas fa-dollar-sign"></i> Ventas</a></li>
                <li><a href="#" onclick="showSection('services')"><i class="fas fa-tools"></i> Servicios</a></li>
                <li><a href="#" onclick="showSection('pipeline')"><i class="fas fa-project-diagram"></i> Pipeline</a></li>
            </ul>
        </nav>
        <button onclick="logout()" style="margin-top: 20px; width: 100%;">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
        </button>
    </div>
    <div id="main-content"></div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Collections
        const inventoryCollection = db.collection('inventory');
        const clientsCollection = db.collection('clients');
        const salesCollection = db.collection('sales');
        const servicesCollection = db.collection('services');
        const pipelineCollection = db.collection('pipeline');

        // Utility functions
        function showSection(section) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '';

            switch(section) {
                case 'dashboard':
                    showDashboard();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'clients':
                    showClients();
                    break;
                case 'sales':
                    showSales();
                    break;
                case 'services':
                    showServices();
                    break;
                case 'pipeline':
                    showPipeline();
                    break;
            }
        }

        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = content;
            modal.style.display = 'block';

            const span = document.getElementsByClassName('close')[0];
            span.onclick = function() {
                modal.style.display = 'none';
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // Dashboard
        async function showDashboard() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h1>Dashboard</h1>
                <div class="dashboard">
                    <div class="card">
                        <h2>Resumen de Ventas</h2>
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Inventario</h2>
                        <canvas id="inventoryChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Clientes Nuevos</h2>
                        <canvas id="clientsChart"></canvas>
                    </div>
                    <div class="card">
                        <h2>Servicios Programados</h2>
                        <ul id="scheduledServices"></ul>
                    </div>
                </div>
            `;

            const sales = await getSales();
            const inventory = await getInventory();
            const clients = await getClients();
            const services = await getServices();

            createSalesChart(sales);
            createInventoryChart(inventory);
            createClientsChart(clients);
            displayScheduledServices(services);
        }

        function createSalesChart(sales) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const monthlySales = sales.reduce((acc, sale) => {
                const month = new Date(sale.date.toDate()).getMonth();
                acc[month] = (acc[month] || 0) + sale.amount;
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [{
                        label: 'Ventas Mensuales',
                        data: Array.from({length: 12}, (_, i) => monthlySales[i] || 0),
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function createInventoryChart(inventory) {
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            const statusCounts = inventory.reduce((acc, vehicle) => {
                acc[vehicle.status] = (acc[vehicle.status] || 0) + 1;
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['rgba(46, 204, 113, 0.6)', 'rgba(231, 76, 60, 0.6)', 'rgba(241, 196, 15, 0.6)'],
                        borderColor: ['rgba(46, 204, 113, 1)', 'rgba(231, 76, 60, 1)', 'rgba(241, 196, 15, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Estado del Inventario'
                        }
                    }
                }
            });
        }

        function createClientsChart(clients) {
            const ctx = document.getElementById('clientsChart').getContext('2d');
            const clientsPerMonth = clients.reduce((acc, client) => {
                const month = new Date(client.createdAt.toDate()).getMonth();
                acc[month] = (acc[month] || 0) + 1;
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [{
                        label: 'Nuevos Clientes',
                        data: Array.from({length: 12}, (_, i) => clientsPerMonth[i] || 0),
                        borderColor: 'rgb(52, 152, 219)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function displayScheduledServices(services) {
            const servicesList = document.getElementById('scheduledServices');
            services.filter(service => service.status === 'Programado')
                    .sort((a, b) => a.date.toDate() - b.date.toDate())
                    .slice(0, 5)  // Mostrar solo los pr√≥ximos 5 servicios
                    .forEach(service => {
                        const li = document.createElement('li');
                        li.textContent = `${service.date.toDate().toLocaleDateString()}: ${service.description}`;
                        servicesList.appendChild(li);
                    });
        }

        // Inventory
        async function showInventory() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h1>Inventario</h1>
                <button onclick="showAddVehicleForm()">Agregar Veh√≠culo</button>
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>A√±o</th>
                            <th>Precio</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;

            const inventory = await getInventory();
            const tableBody = document.querySelector('#inventoryTable tbody');
            inventory.forEach(vehicle => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${vehicle.brand}</td>
                    <td>${vehicle.model}</td>
                    <td>${vehicle.year}</td>
                    <td>$${vehicle.price.toLocaleString()}</td>
                    <td>${vehicle.status}</td>
                    <td>
                        <button onclick="editVehicle('${vehicle.id}')">Editar</button>
                        <button onclick="deleteVehicle('${vehicle.id}')">Eliminar</button>
                    </td>
                `;
            });
        }

        function showAddVehicleForm() {
            const formHTML = `
                <h2>Agregar Veh√≠culo</h2>
                <form id="addVehicleForm">
                    <div class="form-group">
                        <label for="brand">Marca:</label>
                        <input type="text" id="brand" required>
                    </div>
                    <div class="form-group">
                        <label for="model">Modelo:</label>
                        <input type="text" id="model" required>
                    </div>
                    <div class="form-group">
                        <label for="year">A√±o:</label>
                        <input type="number" id="year" required>
                    </div>
                    <div class="form-group">
                        <label for="price">Precio:</label>
                        <input type="number" id="price" required>
                    </div>
                    <div class="form-group">
                        <label for="status">Estado:</label>
                        <select id="status">
                            <option value="Disponible">Disponible</option>
                            <option value="Vendido">Vendido</option>
                            <option value="En reparaci√≥n">En reparaci√≥n</option>
                        </select>
                    </div>
                    <button type="submit">Agregar Veh√≠culo</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('addVehicleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const vehicle = {
                    brand: document.getElementById('brand').value,
                    model: document.getElementById('model').value,
                    year: parseInt(document.getElementById('year').value),
                    price: parseFloat(document.getElementById('price').value),
                    status: document.getElementById('status').value
                };
                await addVehicle(vehicle);
                document.getElementById('modal').style.display = 'none';
                showInventory();
            });
        }

        async function editVehicle(id) {
            const vehicle = await getVehicle(id);
            const formHTML = `
                <h2>Editar Veh√≠culo</h2>
                <form id="editVehicleForm">
                    <div class="form-group">
                        <label for="brand">Marca:</label>
                        <input type="text" id="brand" value="${vehicle.brand}" required>
                    </div>
                    <div class="form-group">
                        <label for="model">Modelo:</label>
                        <input type="text" id="model" value="${vehicle.model}" required>
                    </div>
                    <div class="form-group">
                        <label for="year">A√±o:</label>
                        <input type="number" id="year" value="${vehicle.year}" required>
                    </div>
                    <div class="form-group">
                        <label for="price">Precio:</label>
                        <input type="number" id="price" value="${vehicle.price}" required>
                    </div>
                    <div class="form-group">
                        <label for="status">Estado:</label>
                        <select id="status">
                            <option value="Disponible" ${vehicle.status === 'Disponible' ? 'selected' : ''}>Disponible</option>
                            <option value="Vendido" ${vehicle.status === 'Vendido' ? 'selected' : ''}>Vendido</option>
                            <option value="En reparaci√≥n" ${vehicle.status === 'En reparaci√≥n' ? 'selected' : ''}>En reparaci√≥n</option>
                        </select>
                    </div>
                    <button type="submit">Actualizar Veh√≠culo</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('editVehicleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedVehicle = {
                    brand: document.getElementById('brand').value,
                    model: document.getElementById('model').value,
                    year: parseInt(document.getElementById('year').value),
                    price: parseFloat(document.getElementById('price').value),
                    status: document.getElementById('status').value
                };
                await updateVehicle(id, updatedVehicle);
                document.getElementById('modal').style.display = 'none';
                showInventory();
            });
        }

        async function deleteVehicle(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este veh√≠culo?')) {
                await inventoryCollection.doc(id).delete();
                showInventory();
            }
        }

        // Clients
        async function showClients() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h1>Clientes</h1>
                <button onclick="showAddClientForm()">Agregar Cliente</button>
                <table id="clientsTable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Tel√©fono</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;

            const clients = await getClients();
            const tableBody = document.querySelector('#clientsTable tbody');
            clients.forEach(client => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.email}</td>
                    <td>${client.phone}</td>
                    <td>
                        <button onclick="editClient('${client.id}')">Editar</button>
                        <button onclick="deleteClient('${client.id}')">Eliminar</button>
                    </td>
                `;
            });
        }

        function showAddClientForm() {
            const formHTML = `
                <h2>Agregar Cliente</h2>
                <form id="addClientForm">
                    <div class="form-group">
                        <label for="name">Nombre:</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Tel√©fono:</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <button type="submit">Agregar Cliente</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('addClientForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const client = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await addClient(client);
                document.getElementById('modal').style.display = 'none';
                showClients();
            });
        }

        async function editClient(id) {
            const client = await getClient(id);
            const formHTML = `
                <h2>Editar Cliente</h2>
                <form id="editClientForm">
                    <div class="form-group">
                        <label for="name">Nombre:</label>
                        <input type="text" id="name" value="${client.name}" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" value="${client.email}" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Tel√©fono:</label>
                        <input type="tel" id="phone" value="${client.phone}" required>
                    </div>
                    <button type="submit">Actualizar Cliente</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('editClientForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedClient = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value
                };
                await updateClient(id, updatedClient);
                document.getElementById('modal').style.display = 'none';
                showClients();
            });
        }

        async function deleteClient(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este cliente?')) {
                await clientsCollection.doc(id).delete();
                showClients();
            }
        }

        // Sales
        async function showSales() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h1>Ventas</h1>
                <button onclick="showAddSaleForm()">Registrar Venta</button>
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Veh√≠culo</th>
                            <th>Monto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;

            const sales = await getSales();
            const tableBody = document.querySelector('#salesTable tbody');
            for (const sale of sales) {
                const client = await getClient(sale.clientId);
                const vehicle = await getVehicle(sale.vehicleId);
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${new Date(sale.date.toDate()).toLocaleDateString()}</td>
                    <td>${client.name}</td>
                    <td>${vehicle.brand} ${vehicle.model}</td>
                    <td>$${sale.amount.toLocaleString()}</td>
                    <td>
                        <button onclick="editSale('${sale.id}')">Editar</button>
                        <button onclick="deleteSale('${sale.id}')">Eliminar</button>
                    </td>
                `;
            }
        }

        async function showAddSaleForm() {
            const clients = await getClients();
            const vehicles = await getInventory();
            const formHTML = `
                <h2>Registrar Venta</h2>
                <form id="addSaleForm">
                    <div class="form-group">
                        <label for="clientId">Cliente:</label>
                        <select id="clientId" required>
                            ${clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vehicleId">Veh√≠culo:</label>
                        <select id="vehicleId" required>
                            ${vehicles.filter(v => v.status === 'Disponible').map(vehicle => `<option value="${vehicle.id}">${vehicle.brand} ${vehicle.model}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Monto:</label>
                        <input type="number" id="amount" required>
                    </div>
                    <button type="submit">Registrar Venta</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('addSaleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const sale = {
                    clientId: document.getElementById('clientId').value,
                    vehicleId: document.getElementById('vehicleId').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    date: firebase.firestore.FieldValue.serverTimestamp()
                };
                await addSale(sale);
                await updateVehicle(sale.vehicleId, { status: 'Vendido' });
                document.getElementById('modal').style.display = 'none';
                showSales();
            });
        }

        async function editSale(id) {
            const sale = await getSale(id);
            const clients = await getClients();
            const vehicles = await getInventory();
            const formHTML = `
                <h2>Editar Venta</h2>
                <form id="editSaleForm">
                    <div class="form-group">
                        <label for="clientId">Cliente:</label>
                        <select id="clientId" required>
                            ${clients.map(client => `<option value="${client.id}" ${client.id === sale.clientId ? 'selected' : ''}>${client.name}</option>`).join('')}
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="vehicleId">Veh√≠culo:</label>
                        <select id="vehicleId" required>
                            ${vehicles.map(vehicle => `<option value="${vehicle.id}" ${vehicle.id === sale.vehicleId ? 'selected' : ''}>${vehicle.brand} ${vehicle.model}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Monto:</label>
                        <input type="number" id="amount" value="${sale.amount}" required>
                    </div>
                    <button type="submit">Actualizar Venta</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('editSaleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedSale = {
                    clientId: document.getElementById('clientId').value,
                    vehicleId: document.getElementById('vehicleId').value,
                    amount: parseFloat(document.getElementById('amount').value)
                };
                await updateSale(id, updatedSale);
                document.getElementById('modal').style.display = 'none';
                showSales();
            });
        }

        async function deleteSale(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta venta?')) {
                const sale = await getSale(id);
                await salesCollection.doc(id).delete();
                await updateVehicle(sale.vehicleId, { status: 'Disponible' });
                showSales();
            }
        }

        // Services
        async function showServices() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h1>Servicios</h1>
                <button onclick="showAddServiceForm()">Programar Servicio</button>
                <table id="servicesTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Veh√≠culo</th>
                            <th>Descripci√≥n</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;

            const services = await getServices();
            const tableBody = document.querySelector('#servicesTable tbody');
            for (const service of services) {
                const client = await getClient(service.clientId);
                const vehicle = await getVehicle(service.vehicleId);
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${new Date(service.date.toDate()).toLocaleDateString()}</td>
                    <td>${client.name}</td>
                    <td>${vehicle.brand} ${vehicle.model}</td>
                    <td>${service.description}</td>
                    <td>${service.status}</td>
                    <td>
                        <button onclick="editService('${service.id}')">Editar</button>
                        <button onclick="deleteService('${service.id}')">Eliminar</button>
                    </td>
                `;
            }
        }

        async function showAddServiceForm() {
            const clients = await getClients();
            const vehicles = await getInventory();
            const formHTML = `
                <h2>Programar Servicio</h2>
                <form id="addServiceForm">
                    <div class="form-group">
                        <label for="clientId">Cliente:</label>
                        <select id="clientId" required>
                            ${clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vehicleId">Veh√≠culo:</label>
                        <select id="vehicleId" required>
                            ${vehicles.map(vehicle => `<option value="${vehicle.id}">${vehicle.brand} ${vehicle.model}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">Descripci√≥n:</label>
                        <textarea id="description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="date">Fecha:</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="status">Estado:</label>
                        <select id="status">
                            <option value="Programado">Programado</option>
                            <option value="En progreso">En progreso</option>
                            <option value="Completado">Completado</option>
                        </select>
                    </div>
                    <button type="submit">Programar Servicio</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('addServiceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const service = {
                    clientId: document.getElementById('clientId').value,
                    vehicleId: document.getElementById('vehicleId').value,
                    description: document.getElementById('description').value,
                    date: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('date').value)),
                    status: document.getElementById('status').value
                };
                await addService(service);
                document.getElementById('modal').style.display = 'none';
                showServices();
            });
        }

        async function editService(id) {
            const service = await getService(id);
            const clients = await getClients();
            const vehicles = await getInventory();
            const formHTML = `
                <h2>Editar Servicio</h2>
                <form id="editServiceForm">
                    <div class="form-group">
                        <label for="clientId">Cliente:</label>
                        <select id="clientId" required>
                            ${clients.map(client => `<option value="${client.id}" ${client.id === service.clientId ? 'selected' : ''}>${client.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="vehicleId">Veh√≠culo:</label>
                        <select id="vehicleId" required>
                            ${vehicles.map(vehicle => `<option value="${vehicle.id}" ${vehicle.id === service.vehicleId ? 'selected' : ''}>${vehicle.brand} ${vehicle.model}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">Descripci√≥n:</label>
                        <textarea id="description" required>${service.description}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="date">Fecha:</label>
                        <input type="date" id="date" value="${service.date.toDate().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label for="status">Estado:</label>
                        <select id="status">
                            <option value="Programado" ${service.status === 'Programado' ? 'selected' : ''}>Programado</option>
                            <option value="En progreso" ${service.status === 'En progreso' ? 'selected' : ''}>En progreso</option>
                            <option value="Completado" ${service.status === 'Completado' ? 'selected' : ''}>Completado</option>
                        </select>
                    </div>
                    <button type="submit">Actualizar Servicio</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('editServiceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedService = {
                    clientId: document.getElementById('clientId').value,
                    vehicleId: document.getElementById('vehicleId').value,
                    description: document.getElementById('description').value,
                    date: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('date').value)),
                    status: document.getElementById('status').value
                };
                await updateService(id, updatedService);
                document.getElementById('modal').style.display = 'none';
                showServices();
            });
        }

        async function deleteService(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este servicio?')) {
                await servicesCollection.doc(id).delete();
                showServices();
            }
        }

        // Pipeline
        async function showPipeline() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <h1>Pipeline de Ventas</h1>
                <button onclick="showAddPipelineItemForm()">Agregar Oportunidad</button>
                <div class="pipeline">
                    <div class="pipeline-stage" id="lead">
                        <h3>Lead</h3>
                    </div>
                    <div class="pipeline-stage" id="qualified">
                        <h3>Calificado</h3>
                    </div>
                    <div class="pipeline-stage" id="proposition">
                        <h3>Propuesta</h3>
                    </div>
                    <div class="pipeline-stage" id="negotiation">
                        <h3>Negociaci√≥n</h3>
                    </div>
                    <div class="pipeline-stage" id="closed">
                        <h3>Cerrado</h3>
                    </div>
                </div>
            `;

            const pipelineItems = await getPipelineItems();
            pipelineItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'pipeline-card';
                itemElement.innerHTML = `
                    <h4>${item.clientName}</h4>
                    <p>${item.vehicleName}</p>
                    <p>$${item.amount.toLocaleString()}</p>
                    <button onclick="editPipelineItem('${item.id}')">Editar</button>
                    <button onclick="deletePipelineItem('${item.id}')">Eliminar</button>
                `;
                document.getElementById(item.stage).appendChild(itemElement);
            });
        }

        function showAddPipelineItemForm() {
            const formHTML = `
                <h2>Agregar Oportunidad</h2>
                <form id="addPipelineItemForm">
                    <div class="form-group">
                        <label for="clientName">Nombre del Cliente:</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label for="vehicleName">Veh√≠culo:</label>
                        <input type="text" id="vehicleName" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Monto:</label>
                        <input type="number" id="amount" required>
                    </div>
                    <div class="form-group">
                        <label for="stage">Etapa:</label>
                        <select id="stage">
                            <option value="lead">Lead</option>
                            <option value="qualified">Calificado</option>
                            <option value="proposition">Propuesta</option>
                            <option value="negotiation">Negociaci√≥n</option>
                            <option value="closed">Cerrado</option>
                        </select>
                    </div>
                    <button type="submit">Agregar Oportunidad</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('addPipelineItemForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const pipelineItem = {
                    clientName: document.getElementById('clientName').value,
                    vehicleName: document.getElementById('vehicleName').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    stage: document.getElementById('stage').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await addPipelineItem(pipelineItem);
                document.getElementById('modal').style.display = 'none';
                showPipeline();
            });
        }

        async function editPipelineItem(id) {
            const item = await getPipelineItem(id);
            const formHTML = `
                <h2>Editar Oportunidad</h2>
                <form id="editPipelineItemForm">
                    <div class="form-group">
                        <label for="clientName">Nombre del Cliente:</label>
                        <input type="text" id="clientName" value="${item.clientName}" required>
                    </div>
                    <div class="form-group">
                        <label for="vehicleName">Veh√≠culo:</label>
                        <input type="text" id="vehicleName" value="${item.vehicleName}" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Monto:</label>
                        <input type="number" id="amount" value="${item.amount}" required>
                    </div>
                    <div class="form-group">
                        <label for="stage">Etapa:</label>
                        <select id="stage">
                            <option value="lead" ${item.stage === 'lead' ? 'selected' : ''}>Lead</option>
                            <option value="qualified" ${item.stage === 'qualified' ? 'selected' : ''}>Calificado</option>
                            <option value="proposition" ${item.stage === 'proposition' ? 'selected' : ''}>Propuesta</option>
                            <option value="negotiation" ${item.stage === 'negotiation' ? 'selected' : ''}>Negociaci√≥n</option>
                            <option value="closed" ${item.stage === 'closed' ? 'selected' : ''}>Cerrado</option>
                        </select>
                    </div>
                    <button type="submit">Actualizar Oportunidad</button>
                </form>
            `;
            showModal(formHTML);

            document.getElementById('editPipelineItemForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedItem = {
                    clientName: document.getElementById('clientName').value,
                    vehicleName: document.getElementById('vehicleName').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    stage: document.getElementById('stage').value
                };
                await updatePipelineItem(id, updatedItem);
                document.getElementById('modal').style.display = 'none';
                showPipeline();
            });
        }

        async function deletePipelineItem(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta oportunidad?')) {
                await pipelineCollection.doc(id).delete();
                showPipeline();
            }
        }
// CRUD Operations
        async function addVehicle(vehicle) {
            try {
                const docRef = await inventoryCollection.add(vehicle);
                console.log("Veh√≠culo a√±adido con ID: ", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error al a√±adir veh√≠culo: ", error);
                throw error;
            }
        }

        async function getVehicle(id) {
            try {
                const doc = await inventoryCollection.doc(id).get();
                if (!doc.exists) {
                    throw new Error('Veh√≠culo no encontrado');
                }
                return { id: doc.id, ...doc.data() };
            } catch (error) {
                console.error("Error al obtener veh√≠culo: ", error);
                throw error;
            }
        }

        async function getInventory() {
            try {
                const snapshot = await inventoryCollection.get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener inventario: ", error);
                throw error;
            }
        }

        async function updateVehicle(id, vehicle) {
            try {
                await inventoryCollection.doc(id).update(vehicle);
                console.log("Veh√≠culo actualizado con √©xito");
            } catch (error) {
                console.error("Error al actualizar veh√≠culo: ", error);
                throw error;
            }
        }

        async function addClient(client) {
            try {
                const docRef = await clientsCollection.add(client);
                console.log("Cliente a√±adido con ID: ", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error al a√±adir cliente: ", error);
                throw error;
            }
        }

        async function getClient(id) {
            try {
                const doc = await clientsCollection.doc(id).get();
                if (!doc.exists) {
                    throw new Error('Cliente no encontrado');
                }
                return { id: doc.id, ...doc.data() };
            } catch (error) {
                console.error("Error al obtener cliente: ", error);
                throw error;
            }
        }

        async function getClients() {
            try {
                const snapshot = await clientsCollection.get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener clientes: ", error);
                throw error;
            }
        }

        async function updateClient(id, client) {
            try {
                await clientsCollection.doc(id).update(client);
                console.log("Cliente actualizado con √©xito");
            } catch (error) {
                console.error("Error al actualizar cliente: ", error);
                throw error;
            }
        }

        async function addSale(sale) {
            try {
                const docRef = await salesCollection.add(sale);
                console.log("Venta a√±adida con ID: ", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error al a√±adir venta: ", error);
                throw error;
            }
        }

        async function getSale(id) {
            try {
                const doc = await salesCollection.doc(id).get();
                if (!doc.exists) {
                    throw new Error('Venta no encontrada');
                }
                return { id: doc.id, ...doc.data() };
            } catch (error) {
                console.error("Error al obtener venta: ", error);
                throw error;
            }
        }

        async function getSales() {
            try {
                const snapshot = await salesCollection.get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener ventas: ", error);
                throw error;
            }
        }

        async function updateSale(id, sale) {
            try {
                await salesCollection.doc(id).update(sale);
                console.log("Venta actualizada con √©xito");
            } catch (error) {
                console.error("Error al actualizar venta: ", error);
                throw error;
            }
        }

        async function addService(service) {
            try {
                const docRef = await servicesCollection.add(service);
                console.log("Servicio a√±adido con ID: ", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error al a√±adir servicio: ", error);
                throw error;
            }
        }

        async function getService(id) {
            try {
                const doc = await servicesCollection.doc(id).get();
                if (!doc.exists) {
                    throw new Error('Servicio no encontrado');
                }
                return { id: doc.id, ...doc.data() };
            } catch (error) {
                console.error("Error al obtener servicio: ", error);
                throw error;
            }
        }

        async function getServices() {
            try {
                const snapshot = await servicesCollection.get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener servicios: ", error);
                throw error;
            }
        }

        async function updateService(id, service) {
            try {
                await servicesCollection.doc(id).update(service);
                console.log("Servicio actualizado con √©xito");
            } catch (error) {
                console.error("Error al actualizar servicio: ", error);
                throw error;
            }
        }

        async function addPipelineItem(item) {
            try {
                const docRef = await pipelineCollection.add(item);
                console.log("Item de pipeline a√±adido con ID: ", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error al a√±adir item de pipeline: ", error);
                throw error;
            }
        }

        async function getPipelineItem(id) {
            try {
                const doc = await pipelineCollection.doc(id).get();
                if (!doc.exists) {
                    throw new Error('Item de pipeline no encontrado');
                }
                return { id: doc.id, ...doc.data() };
            } catch (error) {
                console.error("Error al obtener item de pipeline: ", error);
                throw error;
            }
        }

        async function getPipelineItems() {
            try {
                const snapshot = await pipelineCollection.get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error al obtener items de pipeline: ", error);
                throw error;
            }
        }

        async function updatePipelineItem(id, item) {
            try {
                await pipelineCollection.doc(id).update(item);
                console.log("Item de pipeline actualizado con √©xito");
            } catch (error) {
                console.error("Error al actualizar item de pipeline: ", error);
                throw error;
            }
        }

        // Utility Functions
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Authentication
        function showLoginForm() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="login-container">
                    <h2>Iniciar Sesi√≥n</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Contrase√±a:</label>
                            <input type="password" id="password" required>
                        </div>
                        <button type="submit">Iniciar Sesi√≥n</button>
                    </form>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                } catch (error) {
                    console.error("Error de autenticaci√≥n: ", error);
                    showErrorMessage("Error al iniciar sesi√≥n. Por favor, verifique sus credenciales e intente de nuevo.");
                }
            });
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                showLoginForm();
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n: ", error);
                showErrorMessage("Error al cerrar sesi√≥n. Por favor, intente de nuevo.");
            });
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    showDashboard();
                } else {
                    showLoginForm();
                }
            });
        });

        // Error Handling
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Error no capturado:", error);
            showErrorMessage("Ha ocurrido un error inesperado. Por favor, recargue la p√°gina e intente de nuevo.");
            return true;
        };

    </script>
</body>
</html>
        
