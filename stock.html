<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Stock - Automotora</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <style>
        /* ... (estilos sin cambios) ... */
    </style>
</head>
<body>
    <!-- ... (contenido HTML sin cambios) ... -->

    <script>
        // ... (funciones de login y cambio de contraseña sin cambios) ...

        function initializeApp() {
            let stock = JSON.parse(localStorage.getItem('stock')) || [];

            document.getElementById('stockForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                let gastos = [];
                document.querySelectorAll('#gastosInputs > div').forEach(div => {
                    gastos.push({
                        tipo: div.querySelector('.tipoGasto').value,
                        monto: parseFloat(div.querySelector('.montoGasto').value)
                    });
                });
                
                let auto = {
                    modelo: document.getElementById('modelo').value,
                    anio: document.getElementById('anio').value,
                    color: document.getElementById('color').value,
                    precio: parseFloat(document.getElementById('precio').value),
                    precioCompra: parseFloat(document.getElementById('precioCompra').value),
                    imagen: document.getElementById('imagen').value,
                    linkQR: document.getElementById('linkQR').value,
                    gastos: gastos
                };
                
                stock.push(auto);
                actualizarListaStock();
                actualizarResumenGastos();
                guardarStock();
                this.reset();
                document.getElementById('gastosInputs').innerHTML = `
                    <div>
                        <select class="tipoGasto">
                            <option value="reparacion">Reparación</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="impuestos">Impuestos</option>
                            <option value="otro">Otro</option>
                        </select>
                        <input type="number" class="montoGasto" placeholder="Monto del gasto (CLP)" required>
                    </div>
                `;
            });

            // ... (resto del código sin cambios) ...

            function actualizarListaStock() {
                let stockList = document.getElementById('stockList');
                stockList.innerHTML = '';
                
                stock.forEach((auto, index) => {
                    let autoElement = document.createElement('div');
                    autoElement.classList.add('stock-item');
                    let gastosHTML = '<ul class="gastos-list">';
                    auto.gastos.forEach(gasto => {
                        gastosHTML += `<li>${gasto.tipo}: ${formatearPrecioCLP(gasto.monto)}</li>`;
                    });
                    gastosHTML += '</ul>';
                    
                    let qr = qrcode(0, 'L');
                    qr.addData(auto.linkQR);
                    qr.make();
                    let qrImage = qr.createDataURL(4);
                    
                    autoElement.innerHTML = `
                        <h3>${auto.modelo} (${auto.anio})</h3>
                        <p>Color: ${auto.color}</p>
                        <p>Precio de venta: ${formatearPrecioCLP(auto.precio)}</p>
                        <p>Precio de compra: ${formatearPrecioCLP(auto.precioCompra)}</p>
                        <img src="${auto.imagen}" alt="${auto.modelo}" style="max-width: 200px;">
                        <h4>Gastos:</h4>
                        ${gastosHTML}
                        <h4>Código QR:</h4>
                        <img src="${qrImage}" alt="QR Code">
                        <button onclick="eliminarAuto(${index})">Eliminar</button>
                    `;
                    stockList.appendChild(autoElement);
                });
            }

            function actualizarResumenGastos() {
                let gastosSummary = document.getElementById('gastosSummary');
                let totalGastos = {};
                
                stock.forEach(auto => {
                    auto.gastos.forEach(gasto => {
                        if (totalGastos[gasto.tipo]) {
                            totalGastos[gasto.tipo] += gasto.monto;
                        } else {
                            totalGastos[gasto.tipo] = gasto.monto;
                        }
                    });
                });
                
                let gastosOrdenados = Object.entries(totalGastos).sort((a, b) => b[1] - a[1]);
                
                let resumenHTML = '<ul>';
                gastosOrdenados.forEach(([tipo, monto]) => {
                    resumenHTML += `<li>${tipo}: ${formatearPrecioCLP(monto)}</li>`;
                });
                resumenHTML += '</ul>';
                
                gastosSummary.innerHTML = resumenHTML;
            }

            function eliminarAuto(index) {
                stock.splice(index, 1);
                actualizarListaStock();
                actualizarResumenGastos();
                guardarStock();
            }

            function guardarStock() {
                localStorage.setItem('stock', JSON.stringify(stock));
            }

            function formatearPrecioCLP(precio) {
                return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(precio);
            }

            // Inicializar la página
            actualizarListaStock();
            actualizarResumenGastos();
        }

        // Asignar la función eliminarAuto al objeto window para que esté disponible globalmente
        window.eliminarAuto = function(index) {
            let stock = JSON.parse(localStorage.getItem('stock')) || [];
            stock.splice(index, 1);
            localStorage.setItem('stock', JSON.stringify(stock));
            initializeApp();
        };

        // Llamar a initializeApp después de un inicio de sesión exitoso
        function login() {
            const password = document.getElementById('password').value;
            const storedHash = localStorage.getItem('passwordHash');
            const salt = localStorage.getItem('salt');
            const inputHash = hashPassword(password, salt);

            if (inputHash === storedHash) {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                initializeApp();  // Llamar a initializeApp aquí
            } else {
                alert("Contraseña incorrecta. Intente de nuevo.");
            }
        }
    </script>
</body>
</html>
