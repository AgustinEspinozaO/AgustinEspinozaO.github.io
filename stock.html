<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-100">
<head>
    <!-- ... (el resto del head se mantiene igual) ... -->
</head>
<body class="h-full">
    <!-- ... (el resto del HTML se mantiene igual) ... -->

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-analytics.js";
        import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCWOc4NfmUWxM0D386fbQsmjwGIcCxjlPo",
            authDomain: "control-stock-d1c59.firebaseapp.com",
            databaseURL: "https://control-stock-d1c59-default-rtdb.firebaseio.com",
            projectId: "control-stock-d1c59",
            storageBucket: "control-stock-d1c59.appspot.com",
            messagingSenderId: "298416047948",
            appId: "1:298416047948:web:f8897acce0c87e373d31e9",
            measurementId: "G-9R7FF95W92"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // Reference to the 'stock' location in the database
        const stockRef = ref(database, 'stock');

        document.addEventListener('DOMContentLoaded', (event) => {
            const stockForm = document.getElementById('stockForm');
            const addGastoButton = document.getElementById('addGasto');

            if (stockForm) {
                stockForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    let gastos = [];
                    document.querySelectorAll('#gastosInputs > div').forEach(div => {
                        const tipoGasto = div.querySelector('.tipoGasto');
                        const montoGasto = div.querySelector('.montoGasto');
                        if (tipoGasto && montoGasto) {
                            gastos.push({
                                tipo: tipoGasto.value,
                                monto: parseFloat(montoGasto.value) || 0
                            });
                        }
                    });
                    
                    let auto = {
                        modelo: document.getElementById('modelo').value,
                        anio: parseInt(document.getElementById('anio').value) || 0,
                        color: document.getElementById('color').value,
                        precio: parseFloat(document.getElementById('precio').value) || 0,
                        precioCompra: parseFloat(document.getElementById('precioCompra').value) || 0,
                        imagen: document.getElementById('imagen').value,
                        linkQR: document.getElementById('linkQR').value,
                        gastos: gastos
                    };
                    
                    // Add the car to Firebase
                    push(stockRef, auto)
                        .then(() => {
                            console.log("Auto agregado exitosamente");
                            this.reset();
                            resetGastosInputs();
                        })
                        .catch((error) => {
                            console.error("Error al agregar el auto: ", error);
                        });
                });
            }

            if (addGastoButton) {
                addGastoButton.addEventListener('click', function() {
                    let nuevoGasto = document.createElement('div');
                    nuevoGasto.className = 'flex items-center space-x-2 mt-1';
                    nuevoGasto.innerHTML = `
                        <select class="tipoGasto block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="reparacion">Reparación</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="impuestos">Impuestos</option>
                            <option value="otro">Otro</option>
                        </select>
                        <input type="number" class="montoGasto block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Monto del gasto (CLP)">
                    `;
                    document.getElementById('gastosInputs').appendChild(nuevoGasto);
                });
            }

            // Listen for changes in the database and update the list
            onValue(stockRef, (snapshot) => {
                const data = snapshot.val();
                updateStockList(data);
                updateGastosSummary(data);
            }, {
                onlyOnce: false
            });
        });

        function resetGastosInputs() {
            const gastosInputs = document.getElementById('gastosInputs');
            if (gastosInputs) {
                gastosInputs.innerHTML = `
                    <div class="flex items-center space-x-2 mt-1">
                        <select class="tipoGasto block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="reparacion">Reparación</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="impuestos">Impuestos</option>
                            <option value="otro">Otro</option>
                        </select>
                        <input type="number" class="montoGasto block w-1/2 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Monto del gasto (CLP)">
                    </div>
                `;
            }
        }

        function updateStockList(stock) {
            let stockList = document.getElementById('stockList');
            if (stockList) {
                stockList.innerHTML = '';
                
                for (let [key, auto] of Object.entries(stock || {})) {
                    let autoElement = document.createElement('div');
                    autoElement.className = 'mb-4 p-4 bg-gray-50 rounded-lg';
                    let gastosHTML = '<ul class="list-disc pl-5">';
                    if (auto.gastos && Array.isArray(auto.gastos)) {
                        auto.gastos.forEach(gasto => {
                            gastosHTML += `<li>${gasto.tipo}: ${formatearPrecioCLP(gasto.monto)}</li>`;
                        });
                    }
                    gastosHTML += '</ul>';
                    
                    let qr = qrcode(0, 'L');
                    qr.addData(auto.linkQR || '');
                    qr.make();
                    let qrImage = qr.createDataURL(4);
                    
                    autoElement.innerHTML = `
                        <h3 class="text-lg font-semibold">${auto.modelo} (${auto.anio})</h3>
                        <p>Color: ${auto.color}</p>
                        <p>Precio de venta: ${formatearPrecioCLP(auto.precio)}</p>
                        <p>Precio de compra: ${formatearPrecioCLP(auto.precioCompra)}</p>
                        <img src="${auto.imagen}" alt="${auto.modelo}" class="w-full max-w-xs h-auto my-2">
                        <h4 class="font-medium mt-2">Gastos:</h4>
                        ${gastosHTML}
                        <h4 class="font-medium mt-2">Código QR:</h4>
                        <img src="${qrImage}" alt="QR Code" class="my-2">
                        <button onclick="eliminarAuto('${key}')" class="mt-2 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            Eliminar
                        </button>
                    `;
                    stockList.appendChild(autoElement);
                }
            }
        }

        function updateGastosSummary(stock) {
            let gastosSummary = document.getElementById('gastosSummary');
            if (gastosSummary) {
                let totalGastos = {};
                
                for (let auto of Object.values(stock || {})) {
                    if (auto.gastos && Array.isArray(auto.gastos)) {
                        auto.gastos.forEach(gasto => {
                            if (totalGastos[gasto.tipo]) {
                                totalGastos[gasto.tipo] += gasto.monto;
                            } else {
                                totalGastos[gasto.tipo] = gasto.monto;
                            }
                        });
                    }
                }
                
                let gastosOrdenados = Object.entries(totalGastos).sort((a, b) => b[1] - a[1]);
                
                let resumenHTML = '<ul class="list-disc pl-5">';
                gastosOrdenados.forEach(([tipo, monto]) => {
                    resumenHTML += `<li>${tipo}: ${formatearPrecioCLP(monto)}</li>`;
                });
                resumenHTML += '</ul>';
                
                gastosSummary.innerHTML = resumenHTML;
            }
        }

        function formatearPrecioCLP(precio) {
            return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(precio);
        }

        // Global function to delete a car
        window.eliminarAuto = function(key) {
            if (confirm('¿Está seguro de que desea eliminar este auto?')) {
                remove(ref(database, 'stock/' + key))
                    .then(() => {
                        console.log("Auto eliminado exitosamente");
                    })
                    .catch((error) => {
                        console.error("Error al eliminar el auto: ", error);
                    });
            }
        };
    </script>
</body>
</html>
