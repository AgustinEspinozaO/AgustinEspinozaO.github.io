<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programa de Caja con Búsqueda</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #e9ecef;
            margin: 0;
        }

        .container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }

        h2 {
            text-align: center;
            color: #343a40;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        select, input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }

        select {
            background-color: #ffffff;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #numPad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .num-button {
            padding: 20px;
            font-size: 24px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .num-button:hover {
            background-color: #0056b3;
        }

        .product-list {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .receipt-content {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: #f8f9fa;
            font-size: 16px;
        }

        .receipt-content h3 {
            text-align: center;
        }

        .receipt-content p {
            margin: 5px 0;
        }

        .receipt-content ul {
            list-style-type: none;
            padding: 0;
        }

        .receipt-content ul li {
            margin: 5px 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Programa de Caja con Búsqueda</h2>

    <!-- Campo de carga del archivo Excel -->
    <label for="fileInput">Cargar archivo Excel:</label>
    <input type="file" id="fileInput" accept=".xlsx, .xls">

    <div class="product-container">
        <label for="searchProduct">Buscar producto por nombre:</label>
        <input type="text" id="searchProduct" placeholder="Escriba el nombre del producto...">

        <label for="product">Selecciona un producto del Excel:</label>
        <select id="product">
            <!-- Los productos serán cargados desde el archivo Excel -->
        </select>

        <label for="priceExcel">Precio del producto:</label>
        <input type="number" id="priceExcel" placeholder="Precio" step="0.01" min="0">

        <label for="quantity">Cantidad:</label>
        <input type="number" id="quantity" placeholder="Cantidad" min="1">

        <button id="addProductFromExcel">Agregar Producto del Excel</button>
    </div>

    <label for="manualProduct">Agregar producto manualmente:</label>
    <input type="text" id="manualProductName" placeholder="Nombre del producto">
    <input type="number" id="manualProductQuantity" placeholder="Cantidad" min="1">
    <input type="number" id="manualProductPrice" placeholder="Precio" step="0.01" min="0">
    <button id="addManualProduct">Agregar Producto Manual</button>

    <div id="numPad">
        <button class="num-button" data-number="1">1</button>
        <button class="num-button" data-number="2">2</button>
        <button class="num-button" data-number="3">3</button>
        <button class="num-button" data-number="4">4</button>
        <button class="num-button" data-number="5">5</button>
        <button class="num-button" data-number="6">6</button>
        <button class="num-button" data-number="7">7</button>
        <button class="num-button" data-number="8">8</button>
        <button class="num-button" data-number="9">9</button>
        <button class="num-button" data-number="0">0</button>
        <button class="num-button" id="clear">C</button>
    </div>

    <div class="product-list" id="productList">
        <!-- Aquí se agregarán los productos seleccionados -->
    </div>

    <button id="generateReceipt">Generar Boleta</button>
    <button id="printReceipt" style="display:none;">Imprimir Boleta</button>

    <div class="receipt-content" id="receiptContent" style="display:none;">
        <h3>Boleta - Emporio Valdiviano</h3>
        <p>Teléfono: +56951589539</p>
        <p>Dirección: Avenida San Martín 01745, Temuco</p>
        <p>Email: contacto@emporiovaldivianoko.cl</p>
        <p>Sitio web: emporiovaldivianoko.cl</p>
        <hr>
        <ul id="receiptItems">
            <!-- Aquí se agregarán los ítems de la boleta -->
        </ul>
        <p>Total: $<span id="receiptTotal">0</span></p>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    let productsFromExcel = [];
    let cart = [];
    let currentInput = '';

    // Función para cargar productos desde un archivo Excel
    document.getElementById('fileInput').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const productsData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                productsFromExcel = [];
                productsData.forEach((row, index) => {
                    if (index === 0 || !row[1] || !row[2]) return; // Saltar la fila de encabezado o filas sin datos
                    const name = row[1]; // Segunda columna para nombre del producto
                    const price = row[2]; // Tercera columna para el precio del producto
                    productsFromExcel.push({ name, price: parseFloat(price) });
                });

                updateProductSelect(productsFromExcel);
            } catch (error) {
                console.error('Error al leer el archivo Excel:', error);
                alert('Error al leer el archivo Excel. Verifica el formato del archivo.');
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // Función para actualizar el menú de selección de productos
    function updateProductSelect(productList) {
        const productSelect = document.getElementById('product');
        productSelect.innerHTML = ''; // Limpiar opciones anteriores

        productList.forEach(product => {
            const option = document.createElement('option');
            option.value = product.name;
            option.textContent = `${product.name} - Precio: $${product.price.toFixed(2)}`;
            productSelect.appendChild(option);
        });
    }

    // Filtrar productos mientras se escribe en la barra de búsqueda
    document.getElementById('searchProduct').addEventListener('input', (event) => {
        const searchQuery = event.target.value.toLowerCase();
        const filteredProducts = productsFromExcel.filter(product => 
            product.name.toLowerCase().includes(searchQuery)
        );
        updateProductSelect(filteredProducts);
    });

    // Cargar el precio del producto seleccionado
    document.getElementById('product').addEventListener('change', (event)=> {
const selectedProduct = productsFromExcel.find(product => product.name === event.target.value);
if (selectedProduct) {
document.getElementById(‘priceExcel’).value = selectedProduct.price.toFixed(2);
}
});

// Agregar productos del Excel al carrito
document.getElementById('addProductFromExcel').addEventListener('click', () => {
    const selectedProductName = document.getElementById('product').value;
    const quantity = document.getElementById('quantity').value;
    const price = parseFloat(document.getElementById('priceExcel').value);

    if (selectedProductName && quantity && price) {
        cart.push({ name: selectedProductName, quantity: parseInt(quantity), price: price });
        renderCart();
    }
});

// Agregar productos manualmente al carrito
document.getElementById('addManualProduct').addEventListener('click', () => {
    const manualProductName = document.getElementById('manualProductName').value;
    const manualProductQuantity = document.getElementById('manualProductQuantity').value;
    const manualProductPrice = document.getElementById('manualProductPrice').value;
    if (manualProductName && manualProductQuantity && manualProductPrice) {
        cart.push({ name: manualProductName, quantity: parseInt(manualProductQuantity), price: parseFloat(manualProductPrice) });
        renderCart();
    }
});

// Mostrar productos en el carrito
function renderCart() {
    const productList = document.getElementById('productList');
    productList.innerHTML = ''; // Limpiar el contenido anterior

    cart.forEach((product, index) => {
        const productItem = document.createElement('p');
        productItem.textContent = `${product.name} - Cantidad: ${product.quantity} - Precio: $${product.price.toFixed(2)}`;
        productList.appendChild(productItem);
    });
}

// Manejo del teclado numérico
document.querySelectorAll('.num-button').forEach(button => {
    button.addEventListener('click', () => {
        const number = button.dataset.number;
        if (number !== undefined) {
            currentInput += number;
            document.getElementById('priceExcel').value = currentInput;
            document.getElementById('manualProductPrice').value = currentInput;
        } else if (button.id === 'clear') {
            currentInput = '';
            document.getElementById('priceExcel').value = '';
            document.getElementById('manualProductPrice').value = '';
        }
    });
});

// Escuchar eventos del teclado físico
window.addEventListener('keydown', (event) => {
    if (event.key >= '0' && event.key <= '9') {
        currentInput += event.key;
        document.getElementById('priceExcel').value = currentInput;
        document.getElementById('manualProductPrice').value = currentInput;
    } else if (event.key === 'Backspace') {
        currentInput = currentInput.slice(0, -1);
        document.getElementById('priceExcel').value = currentInput;
        document.getElementById('manualProductPrice').value = currentInput;
    }
});

// Generar boleta y mostrarla en pantalla
document.getElementById('generateReceipt').addEventListener('click', () => {
    const receiptItems = document.getElementById('receiptItems');
    receiptItems.innerHTML = '';

    let total = 0;
    cart.forEach(product => {
        const listItem = document.createElement('li');
        listItem.textContent = `${product.name} - Cantidad: ${product.quantity} - Precio: $${product.price.toFixed(2)}`;
        receiptItems.appendChild(listItem);
        total += product.quantity * product.price;
    });

    document.getElementById('receiptTotal').textContent = total.toFixed(2);
    document.getElementById('receiptContent').style.display = 'block';
    document.getElementById('printReceipt').style.display = 'block';

    // Resetear carrito después de generar la boleta
    cart = [];
    renderCart();
});

// Imprimir boleta
document.getElementById('printReceipt').addEventListener('click', () => {
    const receiptContent = document.getElementById('receiptContent').innerHTML;
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.open();
    printWindow.document.write(`
        <html>
            <head>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        margin: 0;
                        padding: 0;
                    }
                    .receipt {
                        width: 80mm;
                        padding: 10mm;
                        margin: 0 auto;
                        font-size: 14px;
                        border: 1px solid #000;
                    }
                    .receipt h3 {
                        text-align: center;
                        margin: 0;
                    }
                    .receipt p {
                        margin: 5px 0;
                    }
                    .receipt ul {
                        list-style: none;
                        padding: 0;
                    }
                    .receipt ul li {
                        margin: 5px 0;
                    }
                    .receipt hr {
                        border: 0;
                        border-top: 1px solid #000;
                        margin: 10px 0;
                    }
                    .receipt .total {
                        font-weight: bold;
                        text-align: center;
                        margin-top: 10px;
                    }
                </style>
            </head>
            <body>
                <div class="receipt">
                    ${receiptContent}
                    <hr>
                    <p class="total">Total: $${document.getElementById('receiptTotal').textContent}</p>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
});

</script>


</body>
</html>
